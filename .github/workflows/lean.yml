name: Lean 4 CI

on:
  push:
    branches: [ "main" ]
    paths:
      - 'Lean/**'
      - '.github/workflows/lean.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'Lean/**'
      - '.github/workflows/lean.yml'
  workflow_dispatch:

env:
  LEAN_VERSION: "leanprover/lean4:v4.14.0"

jobs:
  build:
    name: Build GIFT Lean Formalization
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Lean

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Set Lean toolchain
        run: |
          elan default ${{ env.LEAN_VERSION }}
          lean --version
          lake --version

      - name: Cache .lake directory
        uses: actions/cache@v4
        with:
          path: |
            Lean/.lake
            ~/.cache/mathlib
            ~/.elan/toolchains
          key: ${{ runner.os }}-lake-${{ hashFiles('Lean/lakefile.lean', 'Lean/lean-toolchain') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-lake-${{ hashFiles('Lean/lakefile.lean', 'Lean/lean-toolchain') }}-
            ${{ runner.os }}-lake-

      - name: Lake update (fetch dependencies)
        run: lake update

      - name: Get Mathlib cache
        run: |
          # Download precompiled Mathlib oleans (crucial for CI speed)
          lake exe cache get || echo "Cache get failed, will build from source"

      - name: Build GIFT
        run: lake build

      - name: Verify no sorry in Certificate
        run: |
          echo "Checking for 'sorry' in Certificate modules..."
          if grep -r "sorry" GIFT/Certificate/; then
            echo "ERROR: Found 'sorry' in Certificate modules!"
            exit 1
          else
            echo "✓ No sorry found in Certificate modules"
          fi

      - name: Check axiom usage (informational)
        run: |
          echo "=== Axiom Audit ==="
          echo "Checking axioms used by main theorem..."
          # This is informational - we expect only standard Lean axioms
          lake env lean --run <<'EOF'
          import GIFT.Certificate.MainTheorem
          #print axioms GIFT.Certificate.GIFT_framework_certified
          EOF
        continue-on-error: true

      - name: Build summary
        if: always()
        run: |
          echo "## GIFT Lean Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lean Version | ${{ env.LEAN_VERSION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Modules | 17 |" >> $GITHUB_STEP_SUMMARY
          echo "| Theorems | ~100 |" >> $GITHUB_STEP_SUMMARY
          if [ -d ".lake/build" ]; then
            echo "| Build | ✓ Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Build | ✗ Failed |" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Lint Lean code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: Lean

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install elan
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y --default-toolchain none
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Set Lean toolchain
        run: elan default ${{ env.LEAN_VERSION }}

      - name: Cache .lake directory
        uses: actions/cache@v4
        with:
          path: |
            Lean/.lake
            ~/.cache/mathlib
            ~/.elan/toolchains
          key: ${{ runner.os }}-lake-${{ hashFiles('Lean/lakefile.lean', 'Lean/lean-toolchain') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-lake-${{ hashFiles('Lean/lakefile.lean', 'Lean/lean-toolchain') }}-
            ${{ runner.os }}-lake-

      - name: Lake update
        run: lake update

      - name: Get Mathlib cache
        run: lake exe cache get || true

      - name: Check for unused imports
        run: |
          echo "Checking for potential issues..."
          # Count lines of Lean code
          LINES=$(find GIFT -name "*.lean" -exec cat {} + | wc -l)
          echo "Total lines of Lean code: $LINES"

          # Count theorems
          THEOREMS=$(grep -r "^theorem\|^lemma" GIFT/ | wc -l)
          echo "Total theorems/lemmas: $THEOREMS"

          # Check for axioms (excluding standard ones)
          echo "Custom axioms declared:"
          grep -r "^axiom" GIFT/ || echo "None found"

      - name: Lint summary
        if: always()
        run: |
          echo "## Lean Lint Summary" >> $GITHUB_STEP_SUMMARY
          LINES=$(find GIFT -name "*.lean" -exec cat {} + | wc -l)
          THEOREMS=$(grep -r "^theorem\|^lemma" GIFT/ | wc -l)
          AXIOMS=$(grep -r "^axiom" GIFT/ | wc -l)
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lines of code | $LINES |" >> $GITHUB_STEP_SUMMARY
          echo "| Theorems/Lemmas | $THEOREMS |" >> $GITHUB_STEP_SUMMARY
          echo "| Custom axioms | $AXIOMS |" >> $GITHUB_STEP_SUMMARY

name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "publications/**"
      - "LICENSE"
  pull_request:
    branches: [main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "publications/**"
      - "LICENSE"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # FAST CHECKS - Run first, fail fast
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install flake8
        run: pip install flake8

      - name: Check for syntax errors
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=__pycache__,*.ipynb_checkpoints,venv,.venv,.git

  # ============================================================================
  # MAIN TEST SUITE
  # ============================================================================
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist

      - name: Run all tests
        run: |
          pytest tests/unit tests/integration tests/regression \
            -v --tb=short \
            --cov=statistical_validation \
            --cov=assets/agents \
            --cov-report=xml \
            --cov-report=term-missing:skip-covered \
            -m "not slow" \
            --ignore=tests/legacy

      - name: Run G2 ML tests
        run: |
          pytest G2_ML/tests -v --tb=short -m "not slow" || true

      - name: Run research module tests
        run: |
          pytest G2_ML/research_modules/harmonic_yukawa/tests -v --tb=short || true

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Test summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit tests | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration tests | Completed |" >> $GITHUB_STEP_SUMMARY
          echo "| Regression tests | Completed |" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # MULTI-VERSION COMPATIBILITY (only on main, not PRs)
  # ============================================================================
  compatibility:
    name: Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.9", "3.10"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run smoke tests
        run: pytest tests/unit/test_smoke.py -v --tb=short

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K7 Manifold - Blueprint Construction Graph</title>
    <script src="https://unpkg.com/d3@7.9.0/dist/d3.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #12171f;
            --bg-tertiary: #1a2028;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --border-color: #2d3640;
            --accent-teal: #2dd4bf;
            --accent-teal-dim: #0d9488;
            --accent-indigo: #818cf8;
            --accent-indigo-dim: #4f46e5;
            --accent-amber: #fbbf24;
            --accent-amber-dim: #d97706;
            --accent-rose: #fb7185;
            --accent-rose-dim: #e11d48;
            --accent-emerald: #34d399;
            --accent-emerald-dim: #059669;
            --edge-color: #3d4654;
            --edge-highlight: #2dd4bf;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', 'Fira Code', 'SF Mono', Consolas, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden;
        }

        .container { display: flex; height: 100vh; }

        .sidebar {
            width: 340px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, #0d9488 0%, #12171f 100%);
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 2px;
            background: linear-gradient(90deg, var(--accent-teal), var(--accent-indigo));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        .info-box {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .info-title {
            font-size: 0.7rem;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .info-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 12px 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value { font-size: 1.3rem; font-weight: 700; color: var(--accent-teal); }
        .stat-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

        .filters {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .filter-title { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .filter-buttons { display: flex; flex-wrap: wrap; gap: 6px; }

        .filter-btn {
            padding: 6px 10px;
            font-size: 0.7rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .filter-btn:hover { border-color: var(--accent-teal); color: var(--text-primary); }
        .filter-btn.active { background: var(--accent-teal-dim); border-color: var(--accent-teal); color: var(--text-primary); }

        .search-container { padding: 16px 20px; border-bottom: 1px solid var(--border-color); }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 0.8rem;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 6px;
            font-family: inherit;
            outline: none;
        }

        .search-input:focus { border-color: var(--accent-teal); }
        .search-input::placeholder { color: var(--text-muted); }

        .detail-panel { flex: 1; overflow-y: auto; padding: 20px; }
        .detail-header { margin-bottom: 16px; }
        .detail-title { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }

        .detail-status {
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.65rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-status.algebraic { background: var(--accent-indigo-dim); color: var(--accent-indigo); }
        .detail-status.topological { background: var(--accent-teal-dim); color: var(--accent-teal); }
        .detail-status.geometric { background: var(--accent-amber-dim); color: var(--accent-amber); }
        .detail-status.derived { background: var(--accent-rose-dim); color: var(--accent-rose); }
        .detail-status.physical { background: var(--accent-emerald-dim); color: var(--accent-emerald); }

        .detail-section { margin-bottom: 16px; }
        .detail-section-title { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }

        .formula-box {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            border-left: 3px solid var(--accent-teal);
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .values-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .value-item { background: var(--bg-tertiary); padding: 10px; border-radius: 6px; }
        .value-label { font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 2px; }
        .value-number { font-size: 0.9rem; font-weight: 600; color: var(--accent-teal); }

        .dependencies-list { display: flex; flex-wrap: wrap; gap: 4px; }

        .dep-tag {
            padding: 4px 8px;
            font-size: 0.65rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .dep-tag:hover { background: var(--accent-teal-dim); color: var(--text-primary); }

        .graph-container { flex: 1; position: relative; overflow: hidden; }
        #graph { width: 100%; height: 100%; }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            gap: 16px;
            font-size: 0.7rem;
        }

        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .legend-dot.algebraic { background: var(--accent-indigo); }
        .legend-dot.topological { background: var(--accent-teal); }
        .legend-dot.geometric { background: var(--accent-amber); }
        .legend-dot.derived { background: var(--accent-rose); }
        .legend-dot.physical { background: var(--accent-emerald); }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 8px;
        }

        .control-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }

        .control-btn:hover { border-color: var(--accent-teal); color: var(--text-primary); }

        .node { cursor: pointer; transition: opacity 0.3s; }
        .node.dimmed { opacity: 0.2; }
        .node-rect { rx: 6; ry: 6; stroke-width: 2; transition: all 0.2s; }

        .node.algebraic .node-rect { fill: var(--accent-indigo-dim); stroke: var(--accent-indigo); }
        .node.topological .node-rect { fill: var(--accent-teal-dim); stroke: var(--accent-teal); }
        .node.geometric .node-rect { fill: var(--accent-amber-dim); stroke: var(--accent-amber); }
        .node.derived .node-rect { fill: var(--accent-rose-dim); stroke: var(--accent-rose); }
        .node.physical .node-rect { fill: var(--accent-emerald-dim); stroke: var(--accent-emerald); }

        .node:hover .node-rect, .node.selected .node-rect {
            stroke-width: 3;
            filter: drop-shadow(0 0 8px currentColor);
        }

        .node-label { fill: var(--text-primary); font-size: 10px; font-family: 'JetBrains Mono', monospace; pointer-events: none; }
        .node-sublabel { fill: var(--text-muted); font-size: 8px; font-family: 'JetBrains Mono', monospace; pointer-events: none; }

        .edge { fill: none; stroke: var(--edge-color); stroke-width: 1.5; transition: all 0.3s; }
        .edge.dimmed { opacity: 0.1; }
        .edge.highlighted { stroke: var(--edge-highlight); stroke-width: 2.5; }

        .layer-label {
            position: absolute;
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.5;
        }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 2rem; margin-bottom: 10px; }

        @media print {
            .sidebar { display: none; }
            .controls { display: none; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <header class="sidebar-header">
                <div class="logo">K7 MANIFOLD BLUEPRINT</div>
                <div class="version">Variational Construction + Joyce Theorem</div>
            </header>

            <div class="info-box">
                <div class="info-title">What is K7?</div>
                <div class="info-text">
                    K7 is a compact 7-dimensional manifold with G2 holonomy. GIFT establishes its existence via variational methods: a physics-informed neural network finds a metric satisfying topological constraints from the TCS framework, then Joyce's theorem guarantees a nearby torsion-free solution.
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value">21</div>
                    <div class="stat-label">b2</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">77</div>
                    <div class="stat-label">b3</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">20×</div>
                    <div class="stat-label">Joyce margin</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-title">Filter by Type</div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="algebraic">Algebraic</button>
                    <button class="filter-btn" data-filter="topological">Topological</button>
                    <button class="filter-btn" data-filter="geometric">Geometric</button>
                    <button class="filter-btn" data-filter="derived">Derived</button>
                    <button class="filter-btn" data-filter="physical">Physical</button>
                </div>
            </div>

            <div class="search-container">
                <input type="text" class="search-input" placeholder="Search components..." id="searchInput">
            </div>

            <div class="detail-panel" id="detailPanel">
                <div class="empty-state">
                    <div class="empty-state-icon">&#9671;</div>
                    <div>Click a node to view details</div>
                </div>
            </div>
        </aside>

        <main class="graph-container">
            <svg id="graph"></svg>
            
            <div class="legend">
                <div class="legend-item"><div class="legend-dot algebraic"></div><span>Algebraic Input</span></div>
                <div class="legend-item"><div class="legend-dot topological"></div><span>Topological</span></div>
                <div class="legend-item"><div class="legend-dot geometric"></div><span>Geometric</span></div>
                <div class="legend-item"><div class="legend-dot derived"></div><span>Derived</span></div>
                <div class="legend-item"><div class="legend-dot physical"></div><span>Physical Output</span></div>
            </div>

            <div class="controls">
                <button class="control-btn" id="zoomIn" title="Zoom In">+</button>
                <button class="control-btn" id="zoomOut" title="Zoom Out">-</button>
                <button class="control-btn" id="resetZoom" title="Reset View">&#8634;</button>
            </div>
        </main>
    </div>

    <script>
        function initGraph() {
            if (typeof d3 === 'undefined') {
                setTimeout(initGraph, 100);
                return;
            }

            const nodes = [
                // Layer 0: TCS Building Blocks (Conceptual)
                { id: "m1_block", label: "M1 Building Block", sublabel: "b2=11, b3=40", layer: 0, status: "algebraic", category: "input",
                  formula: "M1: ACyl G2 manifold asymptotic to S1 × Y3(1)", 
                  description: "First building block for conceptual TCS construction with Calabi-Yau 3-fold Y3(1)",
                  value: "b2(M1) = 11, b3(M1) = 40" },
                  
                { id: "m2_block", label: "M2 Building Block", sublabel: "b2=10, b3=37", layer: 0, status: "algebraic", category: "input",
                  formula: "M2: ACyl G2 manifold asymptotic to S1 × Y3(2)",
                  description: "Second building block for conceptual TCS construction with Calabi-Yau 3-fold Y3(2)",
                  value: "b2(M2) = 10, b3(M2) = 37" },
                  
                { id: "tcs_topology", label: "TCS Topology", sublabel: "K7 = M1 ∪ M2", layer: 0, status: "algebraic", category: "input",
                  formula: "Twisted connected sum gluing",
                  description: "Conceptual TCS construction providing topological constraints",
                  value: "Compact, simply-connected" },

                // Layer 1: Mayer-Vietoris Analysis
                { id: "mayer_vietoris", label: "Mayer-Vietoris", sublabel: "Long exact sequence", layer: 1, status: "topological", category: "construction",
                  formula: "... → H^(k-1)(N) → H^k(K7) → H^k(M1) ⊕ H^k(M2) → ...",
                  description: "Cohomological analysis determining Betti numbers from building blocks",
                  value: "Exact sequence" },

                { id: "overlap_region", label: "Neck N", sublabel: "S1 × Y3", layer: 1, status: "topological", category: "construction",
                  formula: "N ≅ S1 × Y3 (overlap)",
                  description: "Cylindrical neck region where M1 and M2 overlap in TCS picture",
                  value: "dim = 1 + 6 = 7" },

                // Layer 2: Topological Constraints
                { id: "topo_constraints", label: "Topological Constraints", sublabel: "Input to variational", layer: 2, status: "topological", category: "construction",
                  formula: "Fixed by Mayer-Vietoris on TCS",
                  description: "b2, b3, det(g), κT are topological inputs, not free parameters",
                  value: "Zero free parameters" },

                // Layer 3: Topological Invariants (from Mayer-Vietoris)
                { id: "b2_k7", label: "b2(K7)", sublabel: "= 21", layer: 3, status: "topological", category: "invariant",
                  formula: "b2(K7) = b2(M1) + b2(M2) = 11 + 10 = 21",
                  description: "Second Betti number from Mayer-Vietoris: harmonic 2-forms (gauge DOF)",
                  value: "21 (TOPOLOGICAL)" },

                { id: "b3_k7", label: "b3(K7)", sublabel: "= 77", layer: 3, status: "topological", category: "invariant",
                  formula: "b3(K7) = b3(M1) + b3(M2) = 40 + 37 = 77",
                  description: "Third Betti number from Mayer-Vietoris, decomposes as 35 (local) + 42 (global)",
                  value: "77 (TOPOLOGICAL)" },

                { id: "det_g_formula", label: "det(g) target", sublabel: "= 65/32", layer: 3, status: "topological", category: "invariant",
                  formula: "det(g) = (H* - b2 - 13)/2^5 = (99-21-13)/32",
                  description: "Metric determinant target from topological formula",
                  value: "65/32 = 2.03125" },

                { id: "kappa_t_formula", label: "κT target", sublabel: "= 1/61", layer: 3, status: "topological", category: "invariant",
                  formula: "κT = 1/(b3 - dim(G2) - p2) = 1/(77-14-2)",
                  description: "Torsion magnitude from cohomological formula",
                  value: "1/61 = 0.01639" },

                // Layer 4: Variational Problem
                { id: "variational", label: "Variational Problem", sublabel: "PINN minimization", layer: 4, status: "geometric", category: "structure",
                  formula: "min ||dφ||² + ||d*φ||² subject to det(g)=65/32",
                  description: "Physics-informed neural network finds G2 structure satisfying constraints",
                  value: "~200k parameters" },

                { id: "pinn_phi", label: "φ_PINN", sublabel: "Neural 3-form", layer: 4, status: "geometric", category: "structure",
                  formula: "φ: R^7 → Λ^3 (neural network)",
                  description: "G2 3-form parameterized by neural network with 35 output components",
                  value: "C(7,3) = 35 dim" },

                { id: "pinn_metric", label: "g_PINN", sublabel: "Induced metric", layer: 4, status: "geometric", category: "structure",
                  formula: "g_ij = (1/6) Σ φ_ikl φ_jkl",
                  description: "Metric induced from G2 3-form, trained to achieve det(g)=65/32",
                  value: "det = 2.031249" },

                { id: "pinn_torsion", label: "||T||_PINN", sublabel: "= 0.00140", layer: 4, status: "geometric", category: "structure",
                  formula: "T = d(φ) + d*(*φ)",
                  description: "Torsion norm achieved by PINN, 20× below Joyce threshold",
                  value: "0.00140" },

                // Layer 5: Joyce Perturbation Theorem
                { id: "joyce_threshold", label: "Joyce ε0", sublabel: "= 0.0288", layer: 5, status: "derived", category: "derived",
                  formula: "ε0 from Sobolev constants (conservative estimate)",
                  description: "Threshold for Joyce's perturbation theorem to apply",
                  value: "0.0288" },

                { id: "joyce_margin", label: "Safety Margin", sublabel: "= 20×", layer: 5, status: "derived", category: "derived",
                  formula: "ε0 / ||T|| = 0.0288 / 0.00140 ≈ 20",
                  description: "PINN torsion is 20× below Joyce threshold",
                  value: "20× margin" },

                { id: "joyce_existence", label: "Joyce Theorem", sublabel: "∃ φ_exact", layer: 5, status: "derived", category: "derived",
                  formula: "||T(φ0)|| < ε0 ⟹ ∃ φ torsion-free",
                  description: "Joyce's theorem guarantees existence of exact G2 structure nearby",
                  value: "Existence proven" },

                // Layer 6: Lean 4 Certification
                { id: "lean_certificate", label: "Lean 4 Certificate", sublabel: "Machine-checked", layer: 6, status: "physical", category: "physics",
                  formula: "theorem k7_admits_torsion_free_g2",
                  description: "Formal proof in Lean 4 that K7 admits torsion-free G2 structure",
                  value: "PROVEN" },

                { id: "banach_fp", label: "Banach Fixed Point", sublabel: "Mathlib", layer: 6, status: "physical", category: "physics",
                  formula: "ContractingWith K=0.9 JoyceFlow",
                  description: "Joyce flow is contraction with fixed point = torsion-free metric",
                  value: "No axioms" },

                // Layer 7: Physical Outputs
                { id: "n_gen", label: "N_gen", sublabel: "= 3", layer: 7, status: "physical", category: "physics",
                  formula: "N_gen = rank(E8) - Weyl = 8 - 5",
                  description: "Number of fermion generations from E8 structure",
                  value: "3 generations" },

                { id: "gauge_dof", label: "Gauge DOF", sublabel: "= 21", layer: 7, status: "physical", category: "physics",
                  formula: "= b2(K7) harmonic 2-forms",
                  description: "Gauge field degrees of freedom: 12 SM + 9 hidden",
                  value: "21 modes" },

                { id: "matter_dof", label: "Matter DOF", sublabel: "= 35 + 42", layer: 7, status: "physical", category: "physics",
                  formula: "b3(K7) = 35 (Λ^3 fiber) + 42 (2×21 TCS)",
                  description: "Matter fields: 35 local + 42 global = 77 total modes",
                  value: "77 modes" },

                { id: "sin2_theta", label: "sin²θ_W", sublabel: "= 3/13", layer: 7, status: "physical", category: "physics",
                  formula: "sin²θW = b2/(b3 + dim(G2)) = 21/91 = 3/13",
                  description: "Weinberg angle from K7 topology (exp: 0.23122)",
                  value: "0.23077 (0.2% error)" },

                { id: "susy", label: "N=1 SUSY", sublabel: "4D preserved", layer: 7, status: "physical", category: "physics",
                  formula: "G2 holonomy ⟹ N=1 in 4D",
                  description: "Exactly one supersymmetry preserved (chiral) in low-energy limit",
                  value: "Minimal SUSY" },
            ];

            const edges = [
                // TCS Building Blocks → Mayer-Vietoris
                { source: "m1_block", target: "mayer_vietoris" },
                { source: "m2_block", target: "mayer_vietoris" },
                { source: "tcs_topology", target: "mayer_vietoris" },
                { source: "tcs_topology", target: "overlap_region" },
                { source: "overlap_region", target: "mayer_vietoris" },
                
                // Mayer-Vietoris → Betti numbers
                { source: "mayer_vietoris", target: "b2_k7" },
                { source: "mayer_vietoris", target: "b3_k7" },
                { source: "m1_block", target: "b2_k7" },
                { source: "m2_block", target: "b2_k7" },
                { source: "m1_block", target: "b3_k7" },
                { source: "m2_block", target: "b3_k7" },
                
                // Betti numbers → Topological formulas
                { source: "b2_k7", target: "det_g_formula" },
                { source: "b3_k7", target: "det_g_formula" },
                { source: "b3_k7", target: "kappa_t_formula" },
                
                // Topological constraints → Variational problem
                { source: "b2_k7", target: "topo_constraints" },
                { source: "b3_k7", target: "topo_constraints" },
                { source: "det_g_formula", target: "topo_constraints" },
                { source: "kappa_t_formula", target: "topo_constraints" },
                
                // Variational problem → PINN solution
                { source: "topo_constraints", target: "variational" },
                { source: "variational", target: "pinn_phi" },
                { source: "pinn_phi", target: "pinn_metric" },
                { source: "pinn_phi", target: "pinn_torsion" },
                { source: "det_g_formula", target: "pinn_metric" },
                
                // PINN torsion → Joyce theorem
                { source: "pinn_torsion", target: "joyce_threshold" },
                { source: "pinn_torsion", target: "joyce_margin" },
                { source: "joyce_threshold", target: "joyce_margin" },
                { source: "joyce_margin", target: "joyce_existence" },
                
                // Joyce → Lean certification
                { source: "joyce_existence", target: "lean_certificate" },
                { source: "joyce_margin", target: "lean_certificate" },
                { source: "lean_certificate", target: "banach_fp" },
                
                // Topological invariants → Physical outputs
                { source: "b2_k7", target: "gauge_dof" },
                { source: "b3_k7", target: "matter_dof" },
                { source: "b2_k7", target: "sin2_theta" },
                { source: "b3_k7", target: "sin2_theta" },
                { source: "joyce_existence", target: "susy" },
                { source: "b2_k7", target: "n_gen" },
                { source: "b3_k7", target: "n_gen" },
            ];

            const svg = d3.select("#graph");
            const container = document.querySelector(".graph-container");
            let width = container.clientWidth;
            let height = container.clientHeight;

            svg.attr("width", width).attr("height", height);

            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on("zoom", (event) => g.attr("transform", event.transform));

            svg.call(zoom);
            const g = svg.append("g");

            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "-0 -5 10 10")
                .attr("refX", 18)
                .attr("refY", 0)
                .attr("orient", "auto")
                .attr("markerWidth", 5)
                .attr("markerHeight", 5)
                .append("path")
                .attr("d", "M 0,-5 L 10,0 L 0,5")
                .attr("fill", "#3d4654");

            const layerHeight = 100;
            const nodeWidth = 110;
            const nodeHeight = 46;
            const startY = 50;

            const layers = {};
            nodes.forEach(node => {
                if (!layers[node.layer]) layers[node.layer] = [];
                layers[node.layer].push(node);
            });

            Object.keys(layers).forEach(layer => {
                const layerNodes = layers[layer];
                const layerWidth = layerNodes.length * (nodeWidth + 20);
                const startX = (width - layerWidth) / 2 + nodeWidth / 2;
                layerNodes.forEach((node, i) => {
                    node.x = startX + i * (nodeWidth + 20);
                    node.y = startY + parseInt(layer) * layerHeight;
                });
            });

            const nodeMap = {};
            nodes.forEach(n => nodeMap[n.id] = n);

            const edgeElements = g.selectAll(".edge")
                .data(edges)
                .enter()
                .append("path")
                .attr("class", "edge")
                .attr("d", d => {
                    const source = nodeMap[d.source];
                    const target = nodeMap[d.target];
                    if (!source || !target) return "";
                    const midX = (source.x + target.x) / 2;
                    const midY = (source.y + target.y) / 2;
                    const dx = target.x - source.x;
                    const offset = dx === 0 ? 0 : Math.sign(dx) * 15;
                    return `M${source.x},${source.y + nodeHeight/2} Q${midX + offset},${midY} ${target.x},${target.y - nodeHeight/2}`;
                })
                .attr("marker-end", "url(#arrowhead)");

            const nodeElements = g.selectAll(".node")
                .data(nodes)
                .enter()
                .append("g")
                .attr("class", d => `node ${d.status}`)
                .attr("transform", d => `translate(${d.x - nodeWidth/2}, ${d.y - nodeHeight/2})`)
                .on("click", (event, d) => showDetail(d))
                .on("mouseenter", (event, d) => highlightConnections(d))
                .on("mouseleave", () => resetHighlight());

            nodeElements.append("rect")
                .attr("class", "node-rect")
                .attr("width", nodeWidth)
                .attr("height", nodeHeight);

            nodeElements.append("text")
                .attr("class", "node-label")
                .attr("x", nodeWidth / 2)
                .attr("y", nodeHeight / 2 - 4)
                .attr("text-anchor", "middle")
                .text(d => d.label);

            nodeElements.append("text")
                .attr("class", "node-sublabel")
                .attr("x", nodeWidth / 2)
                .attr("y", nodeHeight / 2 + 10)
                .attr("text-anchor", "middle")
                .text(d => d.sublabel);

            function showDetail(d) {
                const panel = document.getElementById("detailPanel");
                const dependsOn = edges.filter(e => e.target === d.id).map(e => nodeMap[e.source]).filter(Boolean);
                const feeds = edges.filter(e => e.source === d.id).map(e => nodeMap[e.target]).filter(Boolean);
                
                panel.innerHTML = `
                    <div class="detail-header">
                        <div class="detail-title">${d.label}</div>
                        <span class="detail-status ${d.status}">${d.status}</span>
                    </div>
                    ${d.description ? `<div class="detail-section"><div class="detail-section-title">Description</div><div style="color: var(--text-secondary); font-size: 0.8rem;">${d.description}</div></div>` : ''}
                    <div class="detail-section">
                        <div class="detail-section-title">Definition</div>
                        <div class="formula-box">${d.formula || 'N/A'}</div>
                    </div>
                    ${d.value ? `
                    <div class="detail-section">
                        <div class="detail-section-title">Value</div>
                        <div class="values-grid">
                            <div class="value-item"><div class="value-label">Result</div><div class="value-number">${d.value}</div></div>
                        </div>
                    </div>` : ''}
                    ${dependsOn.length > 0 ? `<div class="detail-section"><div class="detail-section-title">Depends On</div><div class="dependencies-list">${dependsOn.map(dep => `<span class="dep-tag">${dep.label}</span>`).join('')}</div></div>` : ''}
                    ${feeds.length > 0 ? `<div class="detail-section"><div class="detail-section-title">Feeds Into</div><div class="dependencies-list">${feeds.map(f => `<span class="dep-tag">${f.label}</span>`).join('')}</div></div>` : ''}
                `;
                nodeElements.classed("selected", n => n.id === d.id);
            }

            function highlightConnections(d) {
                const connectedIds = new Set([d.id]);
                edges.forEach(e => {
                    if (e.source === d.id) connectedIds.add(e.target);
                    if (e.target === d.id) connectedIds.add(e.source);
                });
                nodeElements.classed("dimmed", n => !connectedIds.has(n.id));
                edgeElements.classed("dimmed", e => e.source !== d.id && e.target !== d.id)
                           .classed("highlighted", e => e.source === d.id || e.target === d.id);
            }

            function resetHighlight() {
                nodeElements.classed("dimmed", false);
                edgeElements.classed("dimmed", false).classed("highlighted", false);
            }

            // Filters
            document.querySelectorAll(".filter-btn").forEach(btn => {
                btn.addEventListener("click", () => {
                    const filter = btn.dataset.filter;
                    if (filter === "all") {
                        nodeElements.style("display", "block");
                        edgeElements.style("display", "block");
                    } else {
                        nodeElements.style("display", d => d.status === filter ? "block" : "none");
                    }
                    btn.parentElement.querySelectorAll(".filter-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                });
            });

            // Search
            document.getElementById("searchInput").addEventListener("input", (e) => {
                const query = e.target.value.toLowerCase();
                if (query === "") {
                    nodeElements.style("opacity", 1);
                    return;
                }
                nodeElements.style("opacity", d => 
                    d.label.toLowerCase().includes(query) || 
                    d.id.toLowerCase().includes(query) ||
                    (d.description && d.description.toLowerCase().includes(query)) ? 1 : 0.15
                );
            });

            // Zoom controls
            document.getElementById("zoomIn").addEventListener("click", () => svg.transition().call(zoom.scaleBy, 1.3));
            document.getElementById("zoomOut").addEventListener("click", () => svg.transition().call(zoom.scaleBy, 0.7));
            document.getElementById("resetZoom").addEventListener("click", () => svg.transition().call(zoom.transform, d3.zoomIdentity));

            // Resize
            window.addEventListener("resize", () => {
                width = container.clientWidth;
                height = container.clientHeight;
                svg.attr("width", width).attr("height", height);
            });

            // Initial transform
            svg.call(zoom.transform, d3.zoomIdentity.translate(0, 10).scale(0.85));
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGraph);
        } else {
            initGraph();
        }
    </script>
</body>
</html>

